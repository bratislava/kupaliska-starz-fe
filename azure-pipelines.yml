# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master

variables:
  tag: '$(Build.SourceVersion)'
  dockerRepository: bratislava/$(Build.Repository.Name)/$(Build.Repository.Name)
  underscoreName: kupaliska_starz_fe

stages:
- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@2
      inputs:
        containerRegistry: 'Github Packages'
        repository: $(dockerRepository)
        command: 'build'
        Dockerfile: '**/Dockerfile'
        tags: '$(tag)'
      displayName: Build Docker Image
    - task: Docker@2
      inputs:
        containerRegistry: 'Github Packages'
        repository: $(dockerRepository)
        command: 'Push'
        Dockerfile: '**/Dockerfile'
        tags: '$(tag)'
      condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.Reason'], 'Manual')))
      displayName: Push Docker Image (not on PR)
- stage: Staging
  condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.Reason'], 'Manual')))
  variables:
  - group: Kupaliska-Common-Stage
  jobs:
  - deployment: Staging
    environment:
      name: Staging
      resourceType: VirtualMachine
      tags: docker
    variables:
      NAME: $(underscoreName)_stage
      PORT: 9005
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Docker@2
            inputs:
              containerRegistry: 'Github Packages'
              command: 'login'
          - script: |
              docker stop $NAME && docker rm $NAME || true
              docker run -d --name $NAME -p $PORT:80 -e HOST=$HOST -e RECAPTCHA_CLIENT_SECRET=$RECAPTCHA_CLIENT_SECRET --restart unless-stopped docker.pkg.github.com/$DOCKERREPOSITORY:$TAG

- stage: Production
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  variables:
  - group: Kupaliska-Common-Prod
  jobs:
  - deployment: Production
    environment:
      name: Production
      resourceType: VirtualMachine
      tags: docker
    variables:
      NAME: $(underscoreName)
      PORT: 19001
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Docker@2
            inputs:
              containerRegistry: 'Github Packages'
              command: 'login'
          - script: |
              docker stop $NAME && docker rm $NAME || true
              docker run -d --name $NAME -p $PORT:80 -e HOST=$HOST -e RECAPTCHA_CLIENT_SECRET=$RECAPTCHA_CLIENT_SECRET --restart unless-stopped docker.pkg.github.com/$DOCKERREPOSITORY:$TAG